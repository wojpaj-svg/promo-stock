<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Promo Stock ‚Äî Offline Mock</title>
  <style>
    :root{
      --bg:#f6f7f8;
      --card:#ffffff;
      --text:#1b1f24;
      --muted:#5f6b78;
      --border:#e3e7ee;
      --shadow: 0 10px 30px rgba(0,0,0,.06);

      --accent:#7DB442;
      --accent2:#9CC670;

--brandText:#5f8f2e; /* ‚úÖ ciemniejszy zielony na tekst (stock numbers itp.) */
  --brandSoft:#eef6e6; /* ‚úÖ t≈Ço soft */
  --brandBorder: rgba(125,180,66,.28);

      --danger:#d64545;
      --danger2:#ffefef;
      --ok:#2d9d65;

      --radius:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:920px;
      margin:20px auto;
      padding:0 14px 30px;
    }
    header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:14px;
    }
    .brand{display:flex; align-items:center; gap:12px}
    .logo{
  width:42px;height:42px;border-radius:14px;
  background: var(--brandSoft);
  border:1px solid var(--brandBorder);
  box-shadow:none;
  position:relative;
  flex:0 0 auto;
}
.logo:before{
  content:"";
  position:absolute;
  inset:10px;
  border-radius:10px;
  background: linear-gradient(135deg,var(--accent),var(--accent2));
}

    h1{font-size:18px;margin:0}
    .sub{color:var(--muted); font-size:12.5px; margin-top:2px}

    /* Top toggle */
    .tabs{
      display:flex;
      gap:8px;
      background:rgba(255,255,255,.7);
      padding:6px;
      border:1px solid var(--border);
      border-radius:999px;
      width:max-content;
      box-shadow: 0 10px 25px rgba(0,0,0,.05);
    }
    .tab{
      border:0;
      background:transparent;
      padding:10px 14px;
      border-radius:999px;
      cursor:pointer;
      font-weight:950;
      font-size:13px;
      color:var(--muted);
    }
.tab.active{
  background:#fff;
  color: var(--text);
  border:1px solid var(--border);
  box-shadow: 0 8px 20px rgba(0,0,0,.06);
}



    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
    }
    .titleRow{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom:8px;
    }
    .title{
      font-weight:900;
      font-size:14px;
      letter-spacing:.2px;
      text-transform:uppercase;
      color:var(--muted);
      margin:0;
    }

    /* Pills */
    .pill{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      border:1px solid var(--border);
      background:#fff;
      padding:6px 10px;
      border-radius:999px;
      box-shadow: 0 8px 18px rgba(0,0,0,.04);
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      white-space:nowrap;
    }
    .pill.low{
      border-color: rgba(214,69,69,.28);
      background: rgba(214,69,69,.06);
      color: var(--danger);
    }

    /* Buttons */
    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 12px;
      border-radius:14px;
      cursor:pointer;
      font-weight:950;
      font-size:14px;
      color:var(--text);
      box-shadow: 0 8px 18px rgba(0,0,0,.04);
      user-select:none;
    }
   
  /* ‚úÖ one source of truth */
.btnWide{
height:35px;          /* <- dodaj */
  padding:0 10px;       /* <- zamie≈Ñ padding 10px 10px na to, ≈ºeby wysoko≈õƒá by≈Ça sta≈Ça */
  display:inline-flex;  /* <- dodaj */
  align-items:center;   /* <- dodaj */
  justify-content:center; /* <- dodaj */
  width:120px;
  min-width:120px;
  
  font-size:12px;        /* mniejsza czcionka */
  font-weight:900;       /* mniej ‚Äûkrzyczy‚Äù ni≈º 950 */
  letter-spacing:.2px;
}


    .btn:active{transform: translateY(1px)}
   .primary{
  background: rgba(125,180,66,.18);       /* subtelny zielony, nie bia≈Çy */
  border: 1px solid rgba(125,180,66,.38); /* delikatna ramka */
  color: #2a3a1f;                          /* mniej czarny */
  box-shadow: 0 8px 18px rgba(0,0,0,.04);
}
.primary:hover{
  background: rgba(125,180,66,.24);
  border-color: rgba(125,180,66,.48);
}

    .ghost{
  background:#fff;                 /* wyglƒÖda jak normalny button */
  border:1px solid var(--border);  /* zamiast dashed */
  color:var(--muted);
  box-shadow: 0 8px 18px rgba(0,0,0,.04);
}
.ghost:hover{
  border-color: rgba(95,107,120,.35);
  color: var(--text);
}

    /* Kiosk list */
    .items{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:10px;
    }
    .item{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:linear-gradient(180deg, rgba(125,180,66,.06), rgba(255,255,255,0));
      display:grid;
      grid-template-columns: 54px 1fr;
      gap:12px;
      align-items:center;
    }

.item.selected{
  border-color: rgba(125,180,66,.45);
  background: linear-gradient(180deg, rgba(125,180,66,.12), rgba(255,255,255,0));
  box-shadow: 0 0 0 2px rgba(125,180,66,.08);
}
/* ‚úÖ Admin row highlight when Add delivery has a value */
.adminRow.hasDelivery{
  border-color: rgba(125,180,66,.45);
  background: linear-gradient(180deg, rgba(125,180,66,.10), rgba(255,255,255,0));
  box-shadow: 0 0 0 2px rgba(125,180,66,.08);
}


    .ico{
      width:54px;height:54px;border-radius:18px;
      background:#fff;
      border:1px solid var(--border);
      display:grid; place-items:center;
    }

    /* KIOSK ROW */
    .kRow{
      display:grid;
      grid-template-columns: 1fr auto;
      align-items:center;
      gap:12px;
    }

    /* ‚úÖ FIX: remaining pills in ONE centered column across all items */
    .kNameLine{
      display:grid;
      grid-template-columns: clamp(120px, 28vw, 170px) 140px; /* fixed column for remaining pills */
      align-items:center;
      gap:12px;
      min-width:0;
    }
    .kName{
      margin:0;
      font-weight:950;
      font-size:18px;
      line-height:1.05;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
    }
    .kRemain{
      justify-self:center; /* centered inside fixed column */
    }
/* ‚úÖ remaining + reorder pod sobƒÖ, w jednej kolumnie */
.kRemainBox{
  justify-self:center;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}

.kRemain,
.kReorder{
  width: 140px;          /* <- je≈õli chcesz cia≈õniej/szerzej: 130‚Äì160px */
  justify-content:center;
  text-align:center;
}

.kReorder{
  padding:5px 10px;      /* by≈Ço 6px 10px */
  font-size:12px;        /* by≈Ço 12.5px */
  font-weight:850;       /* trochƒô l≈ºej ni≈º 900 */
  box-shadow:none;       /* opcjonalnie: mniej ‚Äúciƒô≈ºkie‚Äù */
}


    .kControls{
      display:flex;
      align-items:center;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:nowrap;
    }

    .btn.icon{
      width:44px;height:44px;padding:0;
      display:grid; place-items:center;
      font-size:18px;
      font-weight:900;
      color:var(--muted);
      background:rgba(255,255,255,.92);
      box-shadow: 0 6px 14px rgba(0,0,0,.035);
    }
    .qty{
  min-width:52px;
  text-align:center;
  font-weight:900;
  font-size:16px;
  padding:10px 12px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#fff;
  color:var(--text);
  transition: all .15s ease;
}

.qty.active{
  background: rgba(125,180,66,.18);
  border:1px solid rgba(125,180,66,.45);
  color: var(--brandText);
  box-shadow: 0 0 0 2px rgba(125,180,66,.15);
}

    
    .qbtn{
      border:1px solid var(--border);
      background:rgba(255,255,255,.92);
      padding:8px 10px;
      border-radius:999px;
      cursor:pointer;
      font-weight:950;
      font-size:12.5px;
      color:var(--muted);
      white-space:nowrap;
    }
    .qbtn:hover{border-color: rgba(125,180,66,.45); color:var(--text)}

    @media (max-width: 760px){
      .kControls{ flex-wrap:wrap; justify-content:flex-start; }
      /* on smaller screens shrink fixed remaining column */
      .kNameLine{ grid-template-columns: clamp(100px, 38vw, 150px) 140px; }
    }

/* ‚úÖ PHONE: header w 1 linii (icon + name + remaining), controls w 1 linii pod spodem */
.kIcoInline{ display:none; } /* default: desktop ukrywa inline icon */

@media (max-width: 420px){

  /* 0) item: usuwamy lewƒÖ kolumnƒô (bo side-icon chowamy) */
  .item{
    grid-template-columns: 1fr;   /* by≈Ço 54px 1fr */
    align-items:start;
  }

  /* 1) desktopowa ikonka po lewej znika na telefonie */
  .kIcoSide{ display:none !important; }

  /* 2) telefonowa ikonka w nag≈Ç√≥wku w≈ÇƒÖcza siƒô */
  .kIcoInline{
    display:grid !important;
    width:54px;
    height:54px;
    border-radius:18px;
    background:#fff;
    border:1px solid var(--border);
    place-items:center;
  }

  /* 3) kRow = 2 wiersze: nag≈Ç√≥wek + kontrolki */
  .kRow{
    grid-template-columns: 1fr;
    gap:10px;
    align-items:start;
  }

  /* 4) nag≈Ç√≥wek w jednej linii: icon | name | remaining */
  .kNameLine{
    display:grid;
    grid-template-columns: 54px 1fr auto;
    align-items:center;
    gap:12px;
    min-width:0;
  }

  .kName{
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
    min-width:0;
    margin:0;
  }

  /* remaining po prawej (i ewentualny reorder pod nim) */
  .kRemainBox{
    justify-self:end;
    align-items:flex-end;
    gap:6px;
  }
  .kRemain, .kReorder{
    width:auto;
    min-width:140px;
    justify-content:center;
    text-align:center;
  }

  /* 5) kontrolki w JEDNEJ linii: ‚àí 0 + +5 +10 +20 */
  .kControls{
    display:grid;
    grid-template-columns: 44px 64px 44px 1fr 1fr 1fr;
    gap:8px;
    align-items:center;
    justify-content:stretch;
  }

  /* przyciski minus/plus */
  .btn.icon{
    width:44px;
    height:44px;
  }

  /* pole qty */
  .qty{
    min-width:64px;
    height:44px;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:0;
  }

  /* szybkie +5/+10/+20 jako ma≈Çe ‚Äúikonki‚Äù (r√≥wna wysoko≈õƒá) */
  .qbtn{
    height:44px;
    padding:0 10px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:14px;
    font-size:13px;
    font-weight:950;
  }
}




    label{
      display:block;
      margin-top:12px;
margin-bottom:5px;
      color:var(--muted);
      font-size:13px;
      font-weight:900;
    }
    textarea, input, select{
      width:100%;
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 12px;
      font-size:14px;
      background:#fff;
      outline:none;
    }
    textarea{min-height:88px; resize:vertical}
#kioskNote::placeholder{
  font-style: italic;
}


/* ‚úÖ Admin: jedna wysoko≈õƒá kontrolek, ≈ºeby ‚Äûpills‚Äù by≈Çy r√≥wne */
.adminRow select,
.adminRow input{
  height:40px;          /* match stockPill */
  padding:0 12px;       /* stabilna wysoko≈õƒá, bez ‚Äûp≈Çywania‚Äù */
  line-height:40px;
}


    .actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
      margin-top:12px;
    }
.actions .btn{
  min-width:110px;
}


    /* Admin */
    .tabsSmall{ margin-bottom:12px; }
    .adminList{display:flex; flex-direction:column; gap:10px;}

  .adminRow{
  border:1px solid var(--border);
  border-radius:16px;
  background:#fff;
  padding:12px;
  display:grid;

  /* ikona | nazwa | in stock | active | threshold | add delivery */
  grid-template-columns: 54px 120px 110px 140px 130px 190px;

  gap:12px;
  align-items:center;
  justify-content: space-between; /* ‚úÖ dobija kolumny do prawej */
}



   
    /* ‚úÖ nowa kolumna "In stock" ‚Äî jak pozosta≈Çe pola */
    .adminRow .cStock{
      display:grid;
      grid-template-rows: 20px auto; /* label | pill */
      row-gap:3px;
      align-items:start;
    }

    /* ‚úÖ pill z liczbƒÖ, wysoko≈õƒá jak inputy/selecty */
.stockPill{
  width:110px;
  height:40px;
  border:1px solid var(--brandBorder);
  border-radius:16px;
  background: var(--brandSoft);
  display:flex;
  align-items:center;
  justify-content:center;

  font-size:15px;
  font-weight:950;
  letter-spacing:.4px;            /* ‚úÖ ‚Äûrozszerzone‚Äù cyfry */
  color: var(--brandText);        /* ‚úÖ ten sam klimat co logo */
  box-shadow: 0 8px 18px rgba(0,0,0,.04);
}



    .stockPill.low{
      border-color: rgba(214,69,69,.28);
      background: rgba(214,69,69,.06);
      color: var(--danger);
    }

    /* ‚úÖ mobile stacking (bez hack√≥w, bez margin-left) */
    @media (max-width: 980px){
      .adminRow{
        grid-template-columns:54px 1fr;
        align-items:start;
      }
      .adminRow .c2,
      .adminRow .cStock,
      .adminRow .c3,
      .adminRow .c4,
      .adminRow .c5{
        grid-column:1/-1;
      }
    }

    .aName{
      font-weight:1000;
      font-size:16px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      min-width:0;
      max-width:260px;
    }

    .fieldTitle{
      font-size:12px;
      color:var(--muted);
      font-weight:950;
      margin-bottom:6px;
      line-height:1.1;
    }

    /* ‚úÖ FIX: identical label row height in c3/c4/c5 so titles align perfectly */
    .adminRow .c3,
    .adminRow .c4,
    .adminRow .c5{
      display:grid;
      grid-template-rows: 20px auto; /* label | control */
      row-gap:3px;
      align-items:start;
    }

    .adminRow .c3 .fieldTitle,
    .adminRow .c4 .fieldTitle,
    .adminRow .c5 .fieldTitle{
      margin:0;
      height:16px;
      display:flex;
      align-items:flex-end;
      line-height:1;
    }

/* ‚úÖ FIX: In stock title na tej samej wysoko≈õci co reszta + zielone wyr√≥≈ºnienie */
.adminRow .cStock .fieldTitle{
  margin:0;
  height:16px;
  display:flex;
  align-items:flex-end;
  line-height:1;
  color: var(--muted);
}


    /* ‚úÖ CHANGED: layout so delete (red) sits above Add in the same right column */
    .addBox{
      display:grid;
      grid-template-columns: 0.8fr auto; /* input | button-stack */
      column-gap:5px;
      align-items:center;
    }

    .addBox input{
      min-width:120px;
    }

/* ‚úÖ tylko placeholder w Add delivery kursywƒÖ */
.adminRow .c5 input::placeholder{
  font-style: italic;
}

    .btnStack{
      display:flex;
      flex-direction:column;
      gap:3px;
      align-items:stretch;
      justify-content:flex-end;
    }

    .btnPill{
      border-radius:999px;
      padding:6px 8px;
      font-size:8px;
      font-weight:950;
      box-shadow:none;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      min-width:30px;
      line-height:0.5;
    }

    .btnPill.primary{
  background: rgba(125,180,66,.18);
  border: 1px solid rgba(125,180,66,.38);
  color: #2a3a1f;
}
.btnPill.primary:hover{
  background: rgba(125,180,66,.24);
  border-color: rgba(125,180,66,.48);
}

    .btnPill.danger{
      background:#f4f6f8;
  border:1px solid var(--border);
  color:#6b7280;
    }

   .bulkBar{
  margin-top:12px;
  padding-top:12px;
  border-top:1px solid var(--border);
 padding-left:12px;
  padding-right:12px;

  /* ‚úÖ zamiast flex -> grid jak w addNew (.row2) */
  display:grid;
  grid-template-columns: 1.4fr .9fr .8fr .8fr;
  align-items:center;
  gap:10px;
}

.bulkHint{
  color:var(--muted);
  font-size:13px;
  font-weight:900;

  /* ‚úÖ hint zajmuje 3 pierwsze kolumny */
  grid-column:1 / 4;
}

.bulkBar button{
  /* ‚úÖ button w ostatniej kolumnie i do prawej */
  grid-column:4 / 5;
  justify-self:end;
}

/* mobile: wracamy do uk≈Çadu ‚Äúpod sobƒÖ‚Äù */
@media (max-width: 720px){
  .bulkBar{
    display:flex;
    flex-direction:column;
    align-items:flex-start;
  }
  .bulkBar button{
    align-self:flex-end;
  }
}


    .addNew{
      border:1px dashed rgba(125,180,66,.4);
  background:rgba(125,180,66,.04);
      border-radius:16px;
      padding:12px;
      margin-top:14px;
    }
    .addNew h3{margin:0 0 8px; font-size:14px}
    .row2{
      display:grid;
      grid-template-columns: 1.4fr .9fr .8fr .8fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 720px){ .row2{grid-template-columns:1fr 1fr} }

    /* History */
    .history{
      display:flex; flex-direction:column; gap:10px;
      max-height:560px; overflow:auto; padding-right:4px;
    }
    .historyTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

/* ‚úÖ History filters: dwa selecty obok siebie, wƒô≈ºsze */
#historyPanel .historyTop > div:first-child{
  display:flex;
  gap:10px;
  align-items:center;
  flex-wrap:nowrap;       /* nie ≈Çamie na 2 linie */
}

#historyPanel .historyTop select{
  width:180px;            /* wƒô≈ºsze */
  max-width:180px;        /* twardy limit */
}

/* mobile: mogƒÖ siƒô zwinƒÖƒá pod siebie */
@media (max-width: 720px){
  #historyPanel .historyTop > div:first-child{
    flex-wrap:wrap;
  }
  #historyPanel .historyTop select{
    width:100%;
    max-width:100%;
  }
}


    .event{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fff;
    }

.event{
  position:relative;
}

.event.selectMode{
  padding-left:44px; /* miejsce na checkbox */
}

.evChk{
  position:absolute;
  left:14px;
  top:14px;
  width:18px;
  height:18px;
}

.event.isSelected{
  border-color: rgba(125,180,66,.45);
  box-shadow: 0 0 0 2px rgba(125,180,66,.08);
}

    
    .eventHead{display:flex; justify-content:space-between; gap:10px; align-items:flex-start;}
    .eventTitle{margin:0; font-weight:1000; font-size:14px}
    .eventMeta{
  margin-top:3px;
  color:var(--muted);
  font-size:12px;
  font-weight:500;  /* by≈Ço 800 */
}

.eventNote{
  margin-top:6px;
margin-bottom:4px;
  color:var(--muted);
  font-size:12.5px;
  font-weight:500;  /* by≈Ço 800 */
  line-height:1.25;
}


    .tag{
      display:inline-flex; align-items:center;
      padding:6px 10px; border-radius:999px;
      font-size:12px; font-weight:1000;
      border:1px solid var(--border);
      background:#fff; color:var(--muted);
      white-space:nowrap;
    }
/* ‚úÖ tagi po prawej: jedna szeroko≈õƒá, wy≈õrodkowany tekst */
.eventHead .tag{
  min-width:140px;          /* dopasowane pod ITEM DELETED */
  justify-content:center;
  text-align:center;
}

    .tag.taken{border-color: rgba(214,69,69,.22); background:rgba(214,69,69,.06); color:var(--danger)}
    .tag.restocked{border-color: rgba(45,157,101,.22); background:rgba(45,157,101,.06); color:var(--ok)}
    .lines{margin-top:10px; display:flex; flex-wrap:wrap; gap:8px}
  /* History chips ‚Äî neutralne, kolor robi tylko TAG */
.line{
  border:1px solid rgba(95,107,120,.22);
  border-radius:999px;
  padding:7px 10px;
  font-size:12.5px;
  font-weight:700;
  background: rgba(245,247,248,.9);
  color: var(--muted);
}
.line .delta{
  color: var(--muted);
  font-weight:700;
  margin-left:6px;
}

/* delikatne rozr√≥≈ºnienie + / - bez czerwonego t≈Ça */
.line .delta.pos{ color: var(--ok); }
.line .delta.neg{ color: var(--danger); }



    /* Modal */
   /* Modal */
.backdrop{
  position:fixed;
  inset:0;
  background:rgba(10,14,18,.32);
  display:none;
  align-items:center;
  justify-content:center;
  padding:16px;
  z-index:1000;
}
.backdrop.show{display:flex;}

.modal{
  width:min(560px, 100%);
  background:#fff;
  color:var(--text);
  border:1px solid rgba(0,0,0,.05);
  border-radius:22px;
  box-shadow: 0 40px 90px rgba(0,0,0,.18);
  padding:18px 18px 16px;
}

.modalHead{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:12px;
  margin-bottom:14px;
}

.modalMeta{
  min-width:0;
}
.mDate{
  font-weight:1000;
  font-size:13px;
  color:var(--text);
  line-height:1.2;
letter-spacing:.2px;
}
.mNote{
  margin-top:14px;
  font-size:13px;
  color:var(--muted);
  line-height:1.25;
  word-break:break-word;
}

.modalItems{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  padding-top:14px;
}

/* chips w modalu ‚Äî neutralne (koniec z r√≥≈ºowym) */
.modalItems .line{
  border:1px solid rgba(95,107,120,.22);
  background: rgba(245,247,248,.9);
  border-radius:999px;
  padding:7px 10px;
  font-size:12.5px;
  font-weight:700;
  color:var(--text);
}
.modalItems .line .delta{
  margin-left:6px;
  font-weight:1000;
  color:var(--muted);
}

.modalActions{
  display:flex;
  gap:10px;
  justify-content:flex-end;
  flex-wrap:wrap;
  margin-top:16px;
}

.mbtn{
  border:1px solid var(--border);
  background:#fff;
  color:var(--muted);
  padding:10px 14px;
  border-radius:14px;
  font-weight:950;
  cursor:pointer;
  box-shadow: 0 8px 18px rgba(0,0,0,.04);
  min-width:110px;
}

/* primary jak Submit */
.mbtn.primary{
  background: rgba(125,180,66,.18);
  border: 1px solid rgba(125,180,66,.38);
  color: #2a3a1f;
  box-shadow: 0 8px 18px rgba(0,0,0,.04);
}
.mbtn.primary:hover{
  background: rgba(125,180,66,.24);
  border-color: rgba(125,180,66,.48);
}

.mbtn[disabled]{opacity:.45; cursor:not-allowed;}


    .miniMsg{
      position:fixed;
      left:50%;
      transform:translateX(-50%);
      top:14px;
      background:#fff;
      border:1px solid var(--border);
      box-shadow:var(--shadow);
      border-radius:999px;
      padding:8px 12px;
      font-size:13px;
      font-weight:900;
      color:var(--muted);
      display:none;
      z-index:2000;
    }
    .miniMsg.show{display:block;}

    /* PRINT table */
    .printHeader, .printTableWrap{display:none;}
    .printHeader{
      margin:0 0 10px;
      font-weight:900;
      color:#111;
    }
    table.printTable{
      width:100%;
      border-collapse:collapse;
      font-size:12px;
    }
    table.printTable th, table.printTable td{
      border:1px solid #d6dce6;
      padding:8px;
      vertical-align:top;
      text-align:left;
    }
    table.printTable th{
      background:#f3f6f9;
      font-weight:900;
    }
    .mono{
  font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
  white-space: nowrap;   /* ‚úÖ NIE ≈ÅAMIE daty/godziny */
}

    .itemsCell{white-space:normal;}
.itemsGrid{
  display:grid;
  grid-template-columns: 1fr 80px; /* name | amount */
  column-gap:12px;
  row-gap:2px;
}
.itemsGrid .amt{
  text-align:right;
  white-space:nowrap;
}
.itemsGrid .name{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}


        @media print{
      header, .tabs, #kioskView, #adminView .tabsSmall, .historyTop, .addNew, .bulkBar { display:none !important; }
      body{ background:#fff; }
      .wrap{ max-width:100%; margin:0; padding:0; }
      .card{ box-shadow:none; border:0; padding:0; }
      #historyPanel .history { display:none !important; }
      .printHeader, .printTableWrap { display:block !important; }
    }

  
  </style>
</head>


<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>Promo Stock</h1>
          <div class="sub" id="subtitle">Kiosk view (QR)</div>
        </div>
      </div>

      <div class="tabs" role="tablist" aria-label="Mode">
        <button class="tab active" id="btnKiosk" role="tab">Kiosk</button>
        <button class="tab" id="btnAdmin" role="tab">Admin</button>
      </div>
    </header>

    <!-- KIOSK -->
    <section id="kioskView" class="card">
      <div class="titleRow">
        <p class="title">Take items</p>
      </div>

      <div class="items" id="kioskItems"></div>

      <label for="kioskNote">Note (optional)</label>
      <textarea id="kioskNote" placeholder="e.g. Istanbul University research visit"></textarea>

      <div class="actions">
        <button class="btn ghost" id="kioskReset">Reset</button>
        <button class="btn primary" id="kioskSubmit">Submit</button>
      </div>
    </section>

    <!-- ADMIN -->
    <section id="adminView" class="card" style="display:none; margin-top:14px;">
      <div class="titleRow">
        <p class="title">Admin</p>
      </div>

      <div class="tabs tabsSmall" role="tablist" aria-label="Admin tabs">
        <button class="tab active" id="tabManage" role="tab">Manage</button>
        <button class="tab" id="tabHistory" role="tab">History</button>
      </div>

      <!-- MANAGE -->
      <div id="managePanel">
        <div class="adminList" id="adminList"></div>

        <div class="bulkBar">
          <div class="bulkHint">Tip: fill multiple ‚ÄúAdd delivery‚Äù fields and submit once.</div>
          <button class="btn primary btnWide" id="bulkAddBtn">Add deliveries</button>

        </div>

        <div class="addNew">
          <h3>Add new item</h3>
          <div class="row2">
            <div>
              <div class="fieldTitle">Name</div>
              <input id="newName" placeholder="e.g. Brochures" />
            </div>
            <div>
              <div class="fieldTitle">Icon</div>
              <select id="newIcon"></select>
            </div>
            <div>
              <div class="fieldTitle">Initial stock</div>
              <input id="newStock" type="number" min="0" value="0" />
            </div>
            <div>
              <div class="fieldTitle">Threshold</div>
              <input id="newThreshold" type="number" min="0" value="200" />
            </div>
          </div>
          <div class="actions">
            <button class="btn primary btnWide" id="addItem">Add item</button>

          </div>
        </div>
      </div>

      <!-- HISTORY -->
      <div id="historyPanel" style="display:none;">
        <div class="historyTop">

 <div id="delBar" style="display:none; margin-bottom:10px; gap:10px; align-items:center; justify-content:flex-end;">
  <span id="selCount" class="eventMeta" style="margin-right:auto;">0 selected</span>
  <button class="btn" id="selAllBtn">Select all</button>
  <button class="btn" id="delSelBtn">Delete selected</button>
  <button class="btn ghost" id="delCancelBtn">Cancel</button>
</div>
          
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <select id="filterType" style="max-width:220px;">
              <option value="all">All actions</option>
              <option value="taken">Taken</option>
              <option value="restocked">Restocked</option>
              <option value="item_added">Item added</option>
              <option value="item_deleted">Item deleted</option>
            </select>
            <select id="filterItem" style="max-width:260px;"></select>
          </div>
<div style="display:flex; gap:10px; flex-wrap:wrap;">
  <button class="btn" id="csvBtn">Download CSV</button>
  <button class="btn" id="delModeBtn">Delete history</button>
  <button class="btn primary" id="printBtn">Print / Save PDF</button>
</div>

</div>


        <div class="printHeader" id="printHeader"></div>
        <div class="printTableWrap">
          <table class="printTable" id="printTable">
            <thead>
              <tr>
               <th style="width:190px;">Date / Time</th>
<th style="width:95px;">Type</th>
<th>Note</th>
<th style="width:220px;">Items</th>

              </tr>
            </thead>
            <tbody id="printTbody"></tbody>
          </table>
        </div>

        <div class="history" id="history"></div>
      </div>

       

        
    </section>
  </div>

 <div class="backdrop" id="modalWrap" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-label="Confirmation">
    <div class="modalHead">
      <div class="modalMeta" id="mMeta">
        <div class="mDate" id="mDate">‚Äî</div>
        <div class="mNote" id="mNote" style="display:none;"></div>
      </div>

      <span class="tag" id="mTag">TAKEN</span>
    </div>

    <div class="modalItems" id="mLines"></div>

    <div class="modalActions">
      <button class="mbtn" id="mUndo">Undo</button>
      <button class="mbtn primary" id="mSaved">Done</button>
    </div>
  </div>
</div>


  <div class="miniMsg" id="miniMsg"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  onSnapshot, 
  doc, 
  updateDoc,
  increment,
  setDoc,
  deleteDoc,
  query,
  orderBy,
  limit
} from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC0nKNfmvD3c9ouqaa9ybiXjgkHqVHA12M",
    authDomain: "promo-stock.firebaseapp.com",
    projectId: "promo-stock",
    storageBucket: "promo-stock.firebasestorage.app",
    messagingSenderId: "663337065636",
    appId: "1:663337065636:web:672590dddb96f633b41a31"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  window.db = db;
window.fb = { 
  collection, addDoc, getDocs, onSnapshot, doc, updateDoc, increment, setDoc, deleteDoc,
  query, orderBy, limit
};


</script>

  
<script>
const state = {
  items: [],
  events: [],
  undo: { timer:null, event:null, expiresAt:0, onUndo:null },
  adminUnlocked: false,

  // ‚úÖ history delete mode
  historySelectMode: false,
  selectedEventDocIds: new Set(),
};



const $ = (s) => document.querySelector(s);
const $$ = (s) => Array.from(document.querySelectorAll(s));
const byId = (id) => state.items.find(x => x.id === id);


function guessIconForName(name){
  const n = String(name||"").toLowerCase();

  if (n.includes("lanyard")) return "lanyard";
  if (n.includes("mug")) return "mug";
  if (n.includes("pen")) return "pen";
  if (n.includes("tote") || n.includes("bag")) return "bag";

  // dodaj swoje regu≈Çy:
  if (n.includes("hoodie")) return "hoodie";
  if (n.includes("cap")) return "cap";
  if (n.includes("bottle")) return "bottle";
  if (n.includes("tshirt") || n.includes("t-shirt")) return "tshirt";

  return "box";
}

  

  // =============================
// FIRESTORE SYNC (REALTIME)
// =============================
function startFirestore(){
  const { collection, onSnapshot, query, orderBy, limit } = window.fb;
  const db = window.db;

  // realtime items
  onSnapshot(collection(db, "items"), (snap)=>{
    const items = [];
    snap.forEach(d=>{
      const data = d.data() || {};
      items.push({
        id: d.id,
        name: data.name ?? d.id,
        icon: data.icon ?? "box",
        stock: Number(data.remaining ?? 0),
        threshold: Number(data.threshold ?? 0),
        active: Boolean(data.active ?? true),
        order: Number(data.order ?? 999),
      });
    });

    items.sort((a,b)=> (a.order??999) - (b.order??999));
    state.items = items;

    // ‚úÖ one-time self-heal: if icon missing -> infer and save to Firestore
(async ()=>{
  const { doc, updateDoc } = window.fb;
  const db = window.db;

  for (const it of items){
    // brak pola icon w dokumencie albo puste
    if (!it.icon || it.icon === "box"){
      const inferred = guessIconForName(it.name);
      if (inferred !== "box"){
        try{
          await updateDoc(doc(db, "items", it.id), { icon: inferred });
        }catch(e){
          console.warn("Icon backfill failed for", it.id, e);
        }
      }
    }
  }
})();


    // od≈õwie≈º UI po zmianie items
    renderKiosk();
    renderAdmin();
    renderHistoryFilters();
    renderHistory();
  });

  // realtime events (history)
  onSnapshot(
    query(collection(db, "events"), orderBy("ts", "desc"), limit(500)),
    (snap) => {
      const evs = [];
      snap.forEach(d => {
        const data = d.data() || {};
        evs.push({
          ...data,
          _docId: d.id,
          id: data.id ?? d.id,
          ts: data.ts ?? nowISO(),
          lines: Array.isArray(data.lines) ? data.lines : []
        });
      });

      state.events = evs;

      // od≈õwie≈º UI historii po zmianie events
      renderHistoryFilters();
      renderHistory();
    }
  );
}



function nowISO(){ return new Date().toISOString(); }
function fmtDT(iso){
  return new Date(iso).toLocaleString(undefined, {
    year: "numeric",
    month: "short",
    day: "2-digit",
    hour: "2-digit",
    minute: "2-digit",
    hour12: false
  });
}

function fmtType(t){
  if (t==="taken") return "Taken";
  if (t==="restocked") return "Restocked";
  if (t==="item_added") return "Item added";
  if (t==="item_deleted") return "Item deleted";
  return t;
}

const ICONS = [
  ["mug","Mug"],
  ["bag","Bag"],
  ["pen","Pen"],
  ["lanyard","Lanyard"],
  ["plate","Plate"],
  ["book","Book"],
  ["brochure","Brochure"],
  ["flyer","Flyer"],
  ["notebook","Notebook"],
  ["poster","Poster"],
  ["sticker","Sticker"],
  ["badge","Badge"],
  ["usb","USB"],
  ["bottle","Bottle"],
  ["tshirt","T-shirt"],
  ["umbrella","Umbrella"],
  ["box","Box"],
  ["gift","Gift"],
  ["key","Keychain"],

  // üî• NEW
  ["towel","Towel"],
  ["hoodie","Hoodie"],
  ["cap","Cap"],
  ["thermos","Thermos"],
  ["powerbank","Powerbank"],
  ["candle","Candle"]
];


function iconSvg(name){
  const common = 'width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.9" stroke-linecap="round" stroke-linejoin="round"';
  switch(name){
    case "mug":
      return `<svg ${common}><path d="M7 7h9v9a4 4 0 0 1-4 4H7z"/><path d="M16 9h2a3 3 0 0 1 0 6h-2"/><path d="M7 7V6a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v1"/></svg>`;
    case "bag":
      return `<svg ${common}><path d="M7 9h10l-1 12H8L7 9z"/><path d="M9 9V7a3 3 0 0 1 6 0v2"/></svg>`;
    case "pen":
      return `<svg ${common}><path d="M12 20h9"/><path d="M16 3l5 5-12 12H4v-5L16 3z"/><path d="M15 4l5 5"/></svg>`;
    case "lanyard":
      return `<svg ${common}><path d="M12 2c3 0 5 2 5 5 0 2-1 3-2 4l-3 3-3-3c-1-1-2-2-2-4 0-3 2-5 5-5z"/><path d="M9 14l3 3 3-3"/><path d="M10 21l2-2 2 2v-8"/></svg>`;
    case "plate":
      return `<svg ${common}><circle cx="12" cy="12" r="9"/><circle cx="12" cy="12" r="4"/></svg>`;
    case "book":
      return `<svg ${common}><path d="M4 19a2 2 0 0 0 2 2h12"/><path d="M4 5a2 2 0 0 1 2-2h12v18H6a2 2 0 0 0-2 2z"/><path d="M8 7h7"/></svg>`;
    case "brochure":
      return `<svg ${common}><path d="M7 3h10v18H7z"/><path d="M9 7h6"/><path d="M9 11h6"/><path d="M9 15h6"/></svg>`;
    case "flyer":
      return `<svg ${common}><path d="M7 3h10l1 2v16H6V5z"/><path d="M9 8h6"/><path d="M9 12h6"/><path d="M9 16h4"/></svg>`;
    case "notebook":
      return `<svg ${common}><path d="M6 4h10a2 2 0 0 1 2 2v14H8a2 2 0 0 0-2 2z"/><path d="M6 4v18"/><path d="M10 8h6"/><path d="M10 12h6"/></svg>`;
    case "poster":
      return `<svg ${common}><path d="M7 4h10v14H7z"/><path d="M7 18h10"/><path d="M10 8h4"/><path d="M10 12h6"/></svg>`;
    case "sticker":
      return `<svg ${common}><path d="M7 3h10v10a8 8 0 0 1-8 8H7z"/><path d="M17 13h-4a2 2 0 0 0-2 2v4"/></svg>`;
    case "badge":
      return `<svg ${common}><path d="M12 2l2 4 4 .5-3 3 .8 4.5-3.8-2-3.8 2 .8-4.5-3-3 4-.5z"/><path d="M9 14v8l3-2 3 2v-8"/></svg>`;
    case "usb":
      return `<svg ${common}><path d="M12 2v11"/><path d="M9 4l3-2 3 2"/><path d="M12 13l-3 3h6z"/><path d="M10 18h4v4h-4z"/></svg>`;
    case "bottle":
      return `<svg ${common}><path d="M10 2h4v3l-1 1v2a4 4 0 0 1 2 3.5V20a2 2 0 0 1-2 2h-2a2 2 0 0 1-2-2V11.5A4 4 0 0 1 11 8V6l-1-1z"/></svg>`;
    case "tshirt":
      return `<svg ${common}><path d="M8 4l4 2 4-2 3 3-2 2v13H7V9L5 7l3-3z"/><path d="M10 6v3h4V6"/></svg>`;
    case "umbrella":
      return `<svg ${common}><path d="M12 3a9 9 0 0 0-9 9h18a9 9 0 0 0-9-9z"/><path d="M12 12v7a2 2 0 0 0 4 0"/></svg>`;
    case "gift":
      return `<svg ${common}><path d="M20 12v10H4V12"/><path d="M2 7h20v5H2z"/><path d="M12 7v15"/><path d="M12 7H7.5a2.5 2.5 0 1 1 0-5C10 2 12 7 12 7z"/><path d="M12 7h4.5a2.5 2.5 0 1 0 0-5C14 2 12 7 12 7z"/></svg>`;
    case "key":
      return `<svg ${common}><path d="M7 14a4 4 0 1 1 3-7l10 10-2 2-2-2-2 2-2-2-2 2z"/><path d="M7 14l-2 2"/></svg>`;
   
    case "towel":
      return `<svg ${common}><rect x="4" y="6" width="16" height="12" rx="2"/><path d="M4 10h16"/></svg>`;

    case "hoodie":
      return `<svg ${common}><path d="M8 4l4-2 4 2 3 3-2 2v11H7V9L5 7l3-3z"/><path d="M10 6v3h4V6"/></svg>`;

    case "cap":
      return `<svg ${common}><path d="M4 12a8 8 0 0 1 16 0"/><path d="M2 12h20"/><path d="M12 12v5"/></svg>`;

    case "thermos":
      return `<svg ${common}><rect x="9" y="3" width="6" height="18" rx="2"/><path d="M9 7h6"/></svg>`;

    case "powerbank":
      return `<svg ${common}><rect x="5" y="7" width="14" height="10" rx="2"/><path d="M19 10h2v4h-2"/></svg>`;

    case "candle":
      return `<svg ${common}><rect x="9" y="8" width="6" height="10" rx="2"/><path d="M12 3c1 1 1 2 0 3-1-1-1-2 0-3z"/></svg>`;


 default:
      return `<svg ${common}><path d="M21 8l-9-5-9 5 9 5 9-5z"/><path d="M3 8v10l9 5 9-5V8"/><path d="M12 13v10"/></svg>`;
  }
}

function flash(msg){
  const el = $("#miniMsg");
  el.textContent = msg;
  el.classList.add("show");
  setTimeout(()=>el.classList.remove("show"), 1700);
}

async function applyEvent(ev){
  // ‚úÖ stock aktualizujemy w Firestore, a UI dostanie update z onSnapshot
  const { doc, updateDoc, increment, addDoc, collection } = window.fb;
  const db = window.db;

  if (ev.type === "taken" || ev.type === "restocked"){
    await Promise.all(ev.lines.map(l=>{
      return updateDoc(doc(db, "items", l.itemId), {
        remaining: increment(l.qty) // taken ma u Ciebie qty ujemne
      });
    }));
  }

  // historia do Firestore (opcjonalnie, ale polecam)
  await addDoc(collection(db, "events"), ev);
}

async function revertEvent(ev){
  const { doc, updateDoc, increment } = window.fb;
  const db = window.db;

  if (ev.type === "taken" || ev.type === "restocked"){
    await Promise.all((ev.lines || []).map(l=>{
      return updateDoc(doc(db, "items", l.itemId), {
        remaining: increment(-l.qty) // cofamy zmianƒô
      });
    }));
  }
}



function openModal({ tagText, tagClass, linesHTML, tsText, noteText, canUndo, onUndo }){
  $("#mTag").textContent = tagText;
  $("#mTag").className = "tag " + tagClass;

  // –¥–∞—Ç–∞ / godzina (zawsze)
  $("#mDate").textContent = (tsText || "").trim() || "‚Äî";

  // notatka (opcjonalnie)
  const note = (noteText || "").trim();
  const mNote = $("#mNote");
  if (note){
    mNote.style.display = "";
    mNote.textContent = note;
  } else {
    mNote.style.display = "none";
    mNote.textContent = "";
  }

  // items
  $("#mLines").innerHTML = linesHTML || "";

  $("#mUndo").disabled = !canUndo;
  $("#mUndo").onclick = () => { if (canUndo && onUndo) onUndo(); closeModal(); };
  $("#mSaved").onclick = () => closeModal();

  $("#modalWrap").classList.add("show");
  $("#modalWrap").setAttribute("aria-hidden","false");
}



function closeModal(){
  $("#modalWrap").classList.remove("show");
  $("#modalWrap").setAttribute("aria-hidden","true");
}
function startUndoWindow(ev, onUndo){
  clearTimeout(state.undo.timer);
  state.undo.event = ev;
  state.undo.onUndo = onUndo;
  state.undo.expiresAt = Date.now() + 10000;
  state.undo.timer = setTimeout(()=>{ $("#mUndo").disabled = true; }, 10000);
}

function renderKiosk(){
  const wrap = $("#kioskItems");
  wrap.innerHTML = "";

  const items = state.items
    .filter(i => i.active)
    .slice()
    .sort((a,b)=>a.order-b.order);

  items.forEach(it => {
    const low = it.stock <= it.threshold;

    const el = document.createElement("div");
    el.className = "item";
    el.dataset.itemId = it.id;

    el.innerHTML = `
     <div class="ico kIcoSide">${iconSvg(it.icon)}</div>

      <div>
        <div class="kRow">
      <div class="kNameLine">
  <div class="ico kIcoInline">${iconSvg(it.icon)}</div>
  <p class="kName">${it.name}</p>

  <div class="kRemainBox">
    <span class="pill kRemain">${it.stock} remaining</span>
    ${low ? `<span class="pill low kReorder">Reorder ‚â§ ${it.threshold}</span>` : ``}
  </div>
</div>



          <div class="kControls">
            <button class="btn icon" data-dec title="Decrease">‚àí</button>
            <div class="qty" data-qty>0</div>
            <button class="btn icon" data-inc title="Increase">+</button>
            
            <button class="qbtn" data-add="5">+5</button>
            <button class="qbtn" data-add="10">+10</button>
            <button class="qbtn" data-add="20">+20</button>
          </div>
        </div>

        
      </div>
    `;

    wrap.appendChild(el);
  });

  wrap.querySelectorAll(".item").forEach(card => {
    card.addEventListener("click", (e)=>{
      const qtyEl = card.querySelector("[data-qty]");
      let qty = parseInt(qtyEl.textContent,10)||0;

      if (e.target.closest("[data-dec]")) qty = Math.max(0, qty-1);
      if (e.target.closest("[data-inc]")) qty = Math.min(999, qty+1);

      const addBtn = e.target.closest("[data-add]");
      if (addBtn){
        qty = Math.min(999, qty + parseInt(addBtn.dataset.add,10));
      }
      qtyEl.textContent = qty;
if(qty > 0){
  qtyEl.classList.add("active");
  card.classList.add("selected");
}else{
  qtyEl.classList.remove("active");
  card.classList.remove("selected");
}


    });
  });
}
function kioskReset(){
  $$("#kioskItems [data-qty]").forEach(x=>x.textContent="0");
  $("#kioskNote").value = "";
}
function kioskSelectionLines(){
  const lines = [];
  $$("#kioskItems .item").forEach(card => {
    const itemId = card.dataset.itemId;
    const qty = parseInt(card.querySelector("[data-qty]").textContent,10)||0;
    if (qty>0) lines.push({ itemId, qty: -qty });
  });
  return lines;
}
function submitTaken(){
  const lines = kioskSelectionLines();
  if (!lines.length){ flash("Select quantities first."); return; }

  const ev = {
    id: crypto.randomUUID(),
    type: "taken",
    ts: nowISO(),
    note: $("#kioskNote").value.trim(),
    lines
  };

  applyEvent(ev);
  renderKiosk();
  kioskReset();
  renderAdmin();

  const chips = lines.map(l=>{
    const it = byId(l.itemId);
    return `<span class="line">${it?it.name:l.itemId}<span class="delta">${l.qty}</span></span>`;
  }).join("");

  // ‚úÖ najpierw ustawiamy undo (≈ºeby state.undo.onUndo istnia≈Ço)
  startUndoWindow(ev, ()=>{
    if (Date.now() <= state.undo.expiresAt && state.undo.event?.id === ev.id){
      revertEvent(ev);
      renderKiosk(); renderAdmin(); renderHistoryFilters(); renderHistory();
    }
  });

  // ‚úÖ potem otwieramy modal
  openModal({
    tagText:"TAKEN",
    tagClass:"taken",
    linesHTML:chips,
    tsText: fmtDT(ev.ts),
    noteText: ev.note ? ev.note : "",
    canUndo:true,
    onUndo: state.undo.onUndo
  });
}



function renderAdmin(){
  if ($("#adminView").style.display === "none") return;

  const list = $("#adminList");
  const items = state.items.slice().sort((a,b)=>a.order-b.order);

  list.innerHTML = items.map(it=>{
    return `
      <div class="adminRow" data-item="${it.id}">
        <div class="ico">${iconSvg(it.icon)}</div>

        <div class="c2">
          <div class="aName">${it.name}</div>
        </div>

        <div class="cStock">
          <div class="fieldTitle">In stock</div>
          <div class="stockPill ${it.stock <= it.threshold ? "low" : ""}">${it.stock}</div>
        </div>

        <div class="c3">
          <div class="fieldTitle">Active in kiosk</div>
          <select data-active>
            <option value="true" ${it.active ? "selected":""}>Yes</option>
            <option value="false" ${!it.active ? "selected":""}>No</option>
          </select>
        </div>

        <div class="c4">
          <div class="fieldTitle">Threshold</div>
          <input data-threshold type="number" min="0" value="${it.threshold}">
        </div>

        <div class="c5">
          <div class="fieldTitle">Add delivery</div>
          <div class="addBox">
              <input data-addqty type="number" min="0" placeholder="">

            <div class="btnStack">
              <button class="btnPill danger" data-del title="Remove item">Del</button>
              <button class="btnPill primary" data-addbtn>Add</button>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join("");

  $$("#adminList .adminRow").forEach(row=>{
    const id = row.dataset.item;
    const it = byId(id);


    // ‚úÖ highlight row when typing delivery qty
    const deliveryInp = row.querySelector("[data-addqty]");
    const syncDeliveryHighlight = () => {
      const v = Math.max(0, parseInt(deliveryInp.value, 10) || 0);
      row.classList.toggle("hasDelivery", v > 0);
    };

    deliveryInp.addEventListener("input", syncDeliveryHighlight);
    deliveryInp.addEventListener("change", syncDeliveryHighlight);
    syncDeliveryHighlight(); // init (np. po renderze)


    row.querySelector("[data-active]").addEventListener("change", async (e)=>{
  const { doc, updateDoc } = window.fb;
  const db = window.db;
  await updateDoc(doc(db, "items", id), { active: e.target.value === "true" });
});


   row.querySelector("[data-threshold]").addEventListener("change", async (e)=>{
  const { doc, updateDoc } = window.fb;
  const db = window.db;
  await updateDoc(doc(db, "items", id), { threshold: Math.max(0, parseInt(e.target.value,10)||0) });
});


    row.querySelector("[data-addbtn]").addEventListener("click", ()=>{
      const inp = row.querySelector("[data-addqty]");
      const qty = Math.max(0, parseInt(inp.value,10)||0);
      if (!qty){ flash("Enter delivery quantity."); return; }

      const ev = { id: crypto.randomUUID(), type:"restocked", ts: nowISO(), note:"", lines:[{ itemId:id, qty:+qty }] };
      applyEvent(ev);
      inp.value = "";
row.classList.remove("hasDelivery");

      renderKiosk(); renderAdmin(); renderHistoryFilters(); renderHistory();

      const chips = ev.lines.map(l=>{
        const it = byId(l.itemId);
        return `<span class="line">${it?it.name:l.itemId}<span class="delta">+${l.qty}</span></span>`;
      }).join("");

      startUndoWindow(ev, ()=>{
        if (Date.now() <= state.undo.expiresAt && state.undo.event?.id === ev.id){
          revertEvent(ev);
          renderKiosk(); renderAdmin(); renderHistoryFilters(); renderHistory();
        }
      });

      openModal({
  tagText:"RESTOCKED",
  tagClass:"restocked",
  linesHTML:chips,
  tsText: fmtDT(ev.ts),
  noteText: "",
  canUndo:true,
  onUndo:state.undo.onUndo
});

    });

    row.querySelector("[data-del]").addEventListener("click", ()=>{
      const itemName = it.name;

      const confirmEv = { id: crypto.randomUUID(), type:"item_deleted", ts: nowISO(), note:`Delete item: ${itemName}`, lines:[{ itemId: it.id, qty: 0 }] };

      const chips = `<span class="line">${itemName}<span class="delta">delete</span></span>`;
      const noteLine = `${fmtDT(confirmEv.ts)} ‚Ä¢ Delete this item from inventory?`;

      const snapshot = JSON.parse(JSON.stringify(it));
      const snapshotIndex = state.items.findIndex(x=>x.id===it.id);

      state.items = state.items.filter(x=>x.id!==it.id);
      
      state.events.push(confirmEv);

      renderKiosk(); renderAdmin(); renderHistoryFilters(); renderHistory();

      startUndoWindow(confirmEv, ()=>{
  state.items.splice(snapshotIndex < 0 ? state.items.length : snapshotIndex, 0, snapshot);
  state.events = state.events.filter(e=>e.id!==confirmEv.id);
  renderKiosk(); renderAdmin(); renderHistoryFilters(); renderHistory();
});


      openModal({ tagText:"DELETE", tagClass:"taken", linesHTML:chips, noteText:noteLine, canUndo:true, onUndo:state.undo.onUndo });
    });
  });

  renderHistoryFilters();


  
  renderHistory();
}

function bulkAddDeliveries(){
  const rows = $$("#adminList .adminRow");
  const lines = [];

  rows.forEach(row=>{
    const itemId = row.dataset.item;
    const inp = row.querySelector("[data-addqty]");
    const qty = Math.max(0, parseInt(inp.value,10)||0);
    if (qty>0) lines.push({ itemId, qty:+qty });
  });

  if (!lines.length){ flash("Fill at least one delivery field."); return; }

  const ev = { id: crypto.randomUUID(), type:"restocked", ts: nowISO(), note:"", lines };
  applyEvent(ev);
  rows.forEach(r=>{
  r.querySelector("[data-addqty]").value = "";
  r.classList.remove("hasDelivery");
});


  renderKiosk(); renderAdmin(); renderHistoryFilters(); renderHistory();

  const chips = ev.lines.map(l=>{
    const it = byId(l.itemId);
    return `<span class="line">${it?it.name:l.itemId}<span class="delta">+${l.qty}</span></span>`;
  }).join("");

  startUndoWindow(ev, ()=>{
    if (Date.now() <= state.undo.expiresAt && state.undo.event?.id === ev.id){
      revertEvent(ev);
      renderKiosk(); renderAdmin(); renderHistoryFilters(); renderHistory();
    }
  });

  openModal({
  tagText:"RESTOCKED",
  tagClass:"restocked",
  linesHTML:chips,
  tsText: fmtDT(ev.ts),
  noteText: "",
  canUndo:true,
  onUndo:state.undo.onUndo
});

}

async function addNewItem(){
  const name = $("#newName").value.trim();
  if (!name){ flash("Enter item name."); return; }

  const icon = $("#newIcon").value;
  const stock = Math.max(0, parseInt($("#newStock").value,10)||0);
  const threshold = Math.max(0, parseInt($("#newThreshold").value,10)||0);
  const id = name.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"") || crypto.randomUUID();

  if (state.items.some(i=>i.id===id)){ flash("Item already exists."); return; }

  const order = Math.max(1, ...state.items.map(i=>i.order)) + 1;
  const newItem = { id, name, icon, stock, threshold, active:true, order };

   const { doc, setDoc, addDoc, collection } = window.fb;
  const db = window.db;

  await setDoc(doc(db, "items", id), {
    name,
    icon,
    remaining: stock,
    threshold,
    active: true,
    order
  });

 const ev = {
  id: crypto.randomUUID(),
  type: "item_added",
  ts: nowISO(),
  note: `Item added: ${name}`,
  lines: [{ itemId: id, qty: 0 }]
};

await addDoc(collection(db, "events"), ev);

$("#newName").value = "";
$("#newStock").value = "0";

const chips = `<span class="line">${name}<span class="delta">added</span></span>`;
const noteLine = `${fmtDT(ev.ts)} ‚Ä¢ Added to inventory (also appears in Kiosk)`;

startUndoWindow(ev, ()=>{
  // tymczasowo: tylko UI (Firestore item ju≈º dodany)
  // docelowo: undo powinno usuwaƒá doc z Firestore (items/id) + event z events
  renderKiosk(); renderAdmin(); renderHistoryFilters(); renderHistory();
});

openModal({
  tagText:"ITEM ADDED",
  tagClass:"restocked",
  linesHTML:chips,
  noteText:noteLine,
  canUndo:true,
  onUndo:state.undo.onUndo
});
}

  function setHistorySelectMode(on){
  state.historySelectMode = !!on;
  if (!on) state.selectedEventDocIds.clear();

  // UI
  $("#delBar").style.display = on ? "flex" : "none";
  $("#delModeBtn").textContent = on ? "Delete mode ON" : "Delete history";

  renderHistory(); // przerysuj listƒô z checkboxami / bez
}

function updateSelCount(){
  $("#selCount").textContent = `${state.selectedEventDocIds.size} selected`;
}

async function deleteSelectedEvents(){
  const n = state.selectedEventDocIds.size;
  if (!n){ flash("Select events first."); return; }

  const ok = confirm(`Delete ${n} selected event(s) permanently?`);
  if (!ok) return;

  const { deleteDoc, doc } = window.fb;
  const db = window.db;

  // kasujemy z Firestore
  await Promise.all([...state.selectedEventDocIds].map(id => deleteDoc(doc(db, "events", id))));

  state.selectedEventDocIds.clear();
  updateSelCount();
  flash("Selected events deleted.");
}

function renderHistoryFilters(){
  const sel = $("#filterItem");
  const items = [{id:"all", name:"All items"}].concat(
    state.items.slice().sort((a,b)=>a.order-b.order).map(i=>({id:i.id, name:i.name}))
  );
  sel.innerHTML = items.map(x=>`<option value="${x.id}">${x.name}</option>`).join("");
}

function eventItemsLines(ev){
  const lines = (ev.lines||[]).map(l=>{
    const it = byId(l.itemId);
    const name = it ? it.name : l.itemId;
    if (ev.type==="taken") return `${name} ${l.qty}`;
    if (ev.type==="restocked") return `${name} +${l.qty}`;
    if (ev.type==="item_added") return `${name} (added)`;
    if (ev.type==="item_deleted") return `${name} (deleted)`;
    return `${name}`;
  });
  return lines;
}

function renderHistory(){
  const box = $("#history");
  const type = $("#filterType").value || "all";
  const item = $("#filterItem").value || "all";

  const events = state.events
    .slice()
    .sort((a,b)=> new Date(b.ts)-new Date(a.ts))
    .filter(ev => type==="all" ? true : ev.type===type)
    .filter(ev => item==="all" ? true : ev.lines?.some(l=>l.itemId===item));

  box.innerHTML = events.map(ev=>{
    let tagClass = "restocked";
    let label = fmtType(ev.type);

    if (ev.type==="taken") tagClass="taken";
    if (ev.type==="item_deleted") tagClass="taken";
    if (ev.type==="restocked") tagClass="restocked";
    if (ev.type==="item_added") tagClass="restocked";

    const note = (ev.note||"").trim();

    const visibleLines = (ev.lines || []).filter(l => item === "all" ? true : l.itemId === item);

const lines = visibleLines

      .map(l=>{
        const it = byId(l.itemId);
        const name = it ? it.name : l.itemId;
        let delta = "";
        if (ev.type==="taken") delta = `${l.qty}`;
        if (ev.type==="restocked") delta = `+${l.qty}`;
        if (ev.type==="item_added") delta = "added";
        if (ev.type==="item_deleted") delta = "deleted";
        const deltaClass = (String(delta).startsWith("+")) ? "pos" : (String(delta).startsWith("-")) ? "neg" : "";
return `<span class="line">${name}<span class="delta ${deltaClass}">${delta}</span></span>`;

      }).join("");

  const checked = state.selectedEventDocIds.has(ev._docId);
const selMode = state.historySelectMode;

return `
  <div class="event ${selMode ? "selectMode" : ""} ${checked ? "isSelected" : ""}" data-evdoc="${ev._docId}">
    ${selMode ? `<input class="evChk" type="checkbox" ${checked ? "checked" : ""} />` : ``}

    <div class="eventHead">
      <div>
        <p class="eventTitle">${label}</p>
        <div class="eventMeta">${fmtDT(ev.ts)}</div>
        ${note ? `<div class="eventNote">${note}</div>` : ``}
      </div>
      <span class="tag ${tagClass}">${label.toUpperCase()}</span>
    </div>

    <div class="lines">${lines}</div>
  </div>
`;

  }).join("") || `<div class="eventMeta">No history yet.</div>`;

  $("#printHeader").textContent = `Generated: ${new Date().toLocaleString()} ‚Äî Promo Stock History`;
  const tbody = $("#printTbody");
  tbody.innerHTML = events.map(ev=>{
    const note = (ev.note||"").trim();
    const visibleLines = (ev.lines || []).filter(l => item === "all" ? true : l.itemId === item);

const itemsHTML = visibleLines.map(l=>{
  const it = byId(l.itemId);
  const name = it ? it.name : l.itemId;

  let amt = "";
  if (ev.type === "taken") amt = `${l.qty}`;
  else if (ev.type === "restocked") amt = `+${l.qty}`;
  else if (ev.type === "item_added") amt = "added";
  else if (ev.type === "item_deleted") amt = "deleted";

  return `<div class="name">${name}</div><div class="amt">${amt}</div>`;
}).join("");

    return `
      <tr>
        <td class="mono">${fmtDT(ev.ts)}</td>
        <td>${fmtType(ev.type)}</td>
        <td>${note ? note : ""}</td>
        <td class="itemsCell"><div class="itemsGrid">${itemsHTML}</div></td>

      </tr>
    `;
  }).join("") || `<tr><td colspan="4">No history yet.</td></tr>`;

    // ‚úÖ click handlers for select mode
  if (state.historySelectMode){
    updateSelCount();

    $$("#history .event").forEach(card=>{
      const id = card.dataset.evdoc;
      const chk = card.querySelector(".evChk");
      if (!id || !chk) return;

      const setOne = (val)=>{
        if (val) state.selectedEventDocIds.add(id);
        else state.selectedEventDocIds.delete(id);
        updateSelCount();
        renderHistory(); // najpro≈õciej: od≈õwie≈º
      };

      chk.addEventListener("click", (e)=>{
        e.stopPropagation();
        setOne(chk.checked);
      });

      card.addEventListener("click", ()=>{
        setOne(!state.selectedEventDocIds.has(id));
      });
    });
}
}

function downloadCSV(){
  const rows = [["datetime","type","note","items"]];
  state.events
    .slice()
    .sort((a,b)=> new Date(a.ts)-new Date(b.ts))
    .forEach(ev=>{
      rows.push([
        fmtDT(ev.ts),
        ev.type,
        (ev.note||"").replaceAll('"','""'),
        eventItemsLines(ev).join(" | ").replaceAll('"','""')
      ]);
    });

  const csv = rows.map(r => r.map(v => `"${String(v)}"`).join(",")).join("\n");
  const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
  const url = URL.createObjectURL(blob);

  const a = document.createElement("a");
  a.href = url;
  a.download = `promo-stock-history-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

async function clearAllEvents(){
  const ok = confirm("This will permanently delete ALL history (events). Continue?");
  if (!ok) return;

  const { collection, getDocs, query, limit, deleteDoc, doc } = window.fb;
  const db = window.db;

  let total = 0;

  // Firestore nie ma "delete collection" ‚Äì kasujemy dokumenty partiami
  while (true){
    const snap = await getDocs(query(collection(db, "events"), limit(500)));
    if (snap.empty) break;

    const deletions = [];
    snap.forEach(d => {
      deletions.push(deleteDoc(doc(db, "events", d.id)));
    });

    await Promise.all(deletions);
    total += deletions.length;
  }

  flash(`History cleared (${total} events deleted).`);
}

  
function adminUnlock(){
  if (state.adminUnlocked) return true;
  const pin = prompt("Admin PIN (offline mock):", "");
  if (pin === "1234"){ state.adminUnlocked = true; return true; }
  return false;
}

function setMode(mode){
  const kiosk = $("#kioskView");
  const admin = $("#adminView");
  const bK = $("#btnKiosk");
  const bA = $("#btnAdmin");

  if (mode === "admin"){
    if (!adminUnlock()){
      flash("Admin access denied.");
      mode = "kiosk";
    }
  }

  bK.classList.toggle("active", mode==="kiosk");
  bA.classList.toggle("active", mode==="admin");

  kiosk.style.display = mode==="kiosk" ? "" : "none";
  admin.style.display = mode==="admin" ? "" : "none";
  $("#subtitle").textContent = mode==="kiosk" ? "Kiosk view (QR)" : "Admin view";

  if (mode==="admin") renderAdmin();
}
function setAdminTab(tab){
  $("#tabManage").classList.toggle("active", tab==="manage");
  $("#tabHistory").classList.toggle("active", tab==="history");
  $("#managePanel").style.display = tab==="manage" ? "" : "none";
  $("#historyPanel").style.display = tab==="history" ? "" : "none";
  if (tab==="history") renderHistory();
}

(function init(){
  $("#newIcon").innerHTML = ICONS.map(([k,label])=>`<option value="${k}">${label}</option>`).join("");

 // ‚úÖ czekamy a≈º Firebase module ustawi window.db i window.fb
const waitFb = setInterval(() => {
  if (window.db && window.fb){
    clearInterval(waitFb);
    startFirestore();      // dopiero teraz jest bezpieczne
    setMode("kiosk");      // mo≈ºesz ustawiƒá tryb po starcie FS
  }
}, 50);



$("#delModeBtn").addEventListener("click", ()=> setHistorySelectMode(!state.historySelectMode));
$("#delCancelBtn").addEventListener("click", ()=> setHistorySelectMode(false));
$("#selAllBtn").addEventListener("click", ()=>{
  // zaznacz wszystkie widoczne (po filtrach)
  $$("#history .event").forEach(e=> state.selectedEventDocIds.add(e.dataset.evdoc));
  updateSelCount();
  renderHistory();
});
$("#delSelBtn").addEventListener("click", deleteSelectedEvents);

  
  $("#btnKiosk").addEventListener("click", ()=>setMode("kiosk"));
  $("#btnAdmin").addEventListener("click", ()=>setMode("admin"));

  $("#kioskReset").addEventListener("click", kioskReset);
  $("#kioskSubmit").addEventListener("click", submitTaken);

  $("#tabManage").addEventListener("click", ()=>setAdminTab("manage"));
  $("#tabHistory").addEventListener("click", ()=>setAdminTab("history"));

  $("#filterType").addEventListener("change", renderHistory);
  $("#filterItem").addEventListener("change", renderHistory);

  $("#addItem").addEventListener("click", addNewItem);
  $("#bulkAddBtn").addEventListener("click", bulkAddDeliveries);

  $("#csvBtn").addEventListener("click", downloadCSV);
  $("#printBtn").addEventListener("click", ()=>{
    setMode("admin");
    setAdminTab("history");
    renderHistory();
    setTimeout(()=>window.print(), 50);
  });

  $("#modalWrap").addEventListener("click", (e)=>{
    if (e.target.id === "modalWrap") closeModal();
  });
})();
</script>




  
</body>
</html>













